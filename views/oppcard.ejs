<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Opportunities</title>
    <style>
        .hidden {
            display: none;
        }

        .containers {
        display: flex;  /* Set to flex for side by side layout */
        justify-content: space-between;  /* Add space between the containers */
        flex-wrap: wrap; /* Optional: wrap containers to new lines if space is limited */
        gap: 20px; /* Optional: Add gap between containers */
        position: relative;
        margin-top: 110px;
        padding: 10px;
        background: var(--light);
    }

    .container {
      position: relative;
      margin: auto;
      overflow: hidden;
      width: 290px;
      height: 350px;
      background: var(--white);
      box-shadow: 7px 9px 16px 0px #847fb6;
      border-radius: 10px;
    }

    .container:hover {
      transform: translateY(-5px);
      transition: all 0.4s ease-in-out;
      cursor: pointer;
    }

    .product-p {
      font-size: 0.6em;
      color: var(--rose);
      letter-spacing: 1px;
      margin-top: 9.6px;
      margin-bottom: 9.6px;
    }

    .product-pl {
      font-size: 1em;
      color: var(--tan);
      letter-spacing: 1px;
    }

    .product-p2 {
      font-size: 0.7em;
      color: var(--dark);
      letter-spacing: 1px;
    }


    .product-h1 {
      font-size: 1.2em;
      color: var(--dark);
      margin-top: -5px;
      margin-bottom: 12.86px;
    }

    .product-h2 {
      color: var(--tan);
      margin-top: -5px;
        margin-bottom: 19.92px;
    }

    .product {
      position: absolute;
      width: 92%;
      height: 90%;
      top: 7%;
      left: 4%;
      right: 4%;
      margin: auto;
    }

    .product-desc {
      text-transform: none;
      letter-spacing: 0;
      margin-top: 11.2px;
      margin-bottom: 17px;
      color: var(--dark);
      font-size: .7em;
      line-height: 1.6em;
      margin-right: 10px;
      text-align: justify;
    }

    .product-buttons {
      margin-top: 3px;
      position: absolute;
      bottom: 3%;
      left: 5%;
      width: 97%;
    }

      .popup-container {
        position: fixed;
        top: 26%;
        left: 34%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .product-selected {
          background: var(--white);
          box-shadow: 0px 0px 20px 13px #847fb6;
          border-radius: 10px;
          padding: 20px;
          width: 500px;
          height: auto;
      }

    

    .product-button-add, .product-button-like {
      /* background: darken(var(--light), 10%); */
      background-color: #CDA9AC;
      padding: 10px;
      display: inline-block;
      outline: 0;
      border: 0;
      /* margin: -1px; */
      border-radius: 2px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--white);
      cursor: pointer;
    }

    .product-button-add:hover, .product-button-like:hover {
      background: var(--rose);
      transition: all .4s ease-in-out;
    }

    .product-button-add {
      width: 67%;
    }

    .product-button-like {
      width: 22%;
    }
  

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <input type="text" id="searchInput" onkeydown="handleSearchEnter(event)" placeholder="Search opportunities...">
    <div class="containers" id="opportunitiesContainer">
        <!-- Your opportunity divs will be here -->
    </div>
    <div class="pagination" id="paginationControls">
        <!-- Pagination buttons will be here -->
    </div>

    <!-- Popup container -->
    <div class="popup-container" style="display: none;"></div>

    <script>
        const itemsPerPage = 10; // Number of items to display per page
        let currentPage = 1;

        window.opportunityData = JSON.parse('<%- opportunityData %>');

        async function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                searchOpportunities();
            }
        }

        async function searchOpportunities() {
            const searchInput = document.getElementById('searchInput');
            const searchValue = searchInput.value.toLowerCase();
            if (!searchValue) {
                return;
            }

            // Update the URL with the search query
            const newUrl = `${window.location.origin}${window.location.pathname}?s=${encodeURIComponent(searchValue)}`;
            history.pushState({ path: newUrl }, '', newUrl);

            const filteredOpportunities = Object.keys(window.opportunityData).reduce((acc, key) => {
                const opportunity = window.opportunityData[key];
                if (opportunity.title.toLowerCase().includes(searchValue) || 
                    opportunity.topic.toLowerCase().includes(searchValue) || 
                    opportunity.location.toLowerCase().includes(searchValue) || 
                    opportunity.institution.toLowerCase().includes(searchValue)) {
                    acc[key] = opportunity;
                }
                return acc;
            }, {});
            window.filteredOpportunities = filteredOpportunities;

            loadOpportunities(filteredOpportunities, currentPage);
            setupPagination(filteredOpportunities);
        }

        function loadOpportunities(opportunities, page) {
            const container = document.getElementById('opportunitiesContainer');
            container.innerHTML = ''; // Clear existing opportunities

            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedOpportunities = Object.keys(opportunities).slice(start, end);

            paginatedOpportunities.forEach(key => {
                const opportunity = opportunities[key];
                let div = document.createElement('div');
                div.classList.add('container');
                div.setAttribute('Opportunity-ID', key);
                div.innerHTML = `
                  <div class="product">
                    <p class="product-p" name="topic">${opportunity.topic}</p>
                    <h2 class="product-h1" name="title">${opportunity.title}</h2>
                    <p class="product-pl" name="location">${opportunity.location}</p>
                    <p class="product-desc" name="shortDescription">${opportunity.shortDescription}</p>
                    <p class="product-p2" name="stipend">stipend: ${opportunity.stipend} </p>
                    <p class="product-p2" name="duration">duration: ${opportunity.duration} </p>
                    <div class="product-buttons">
                      <button class="product-button-add" type="button">Apply Now</button>
                      <button class="product-button-like" type="button"><span>♥</span></button>
                    </div>
                  </div>
                `;
                container.appendChild(div);
            });

            // Reattach event listeners to the new elements
            attachEventListeners();
        }

        function setupPagination(opportunities) {
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.innerHTML = ''; // Clear existing pagination controls

            const totalPages = Math.ceil(Object.keys(opportunities).length / itemsPerPage);

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.addEventListener('click', function() {
                    currentPage = i;
                    loadOpportunities(opportunities, currentPage);
                });
                paginationControls.appendChild(button);
            }
        }

        function attachEventListeners() {
            const containers = document.querySelectorAll('.container');
            const popupContainer = document.querySelector('.popup-container');

            containers.forEach(container => {
                container.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent the click from propagating to the window
                    const opportunityId = this.getAttribute('Opportunity-ID');
                    const opportunity = window.opportunityData[opportunityId];
                    console.log('opportunityId', opportunityId);

                    let popup = document.createElement('div');
                    popup.classList.add('product-selected');
                    popup.innerHTML = `
                        <p class="product-p" name="topic">${opportunity.topic}</p>
                        <h2 class="product-h1" name="title">${opportunity.title}</h2>
                        <p class="product-pl" name="location">${opportunity.location}</p>
                        <p class="product-pl" name="institution">${opportunity.institution}</p>
                        <p class="product-desc" name="longDescription">${opportunity.longDescription}</p>
                        <p class="product-p2" name="stipend">reference: ${opportunity.postBy} </p>
                        <p class="product-p2" name="stipend">stipend: ${opportunity.stipend} </p>
                        <p class="product-p2" name="duration">duration: ${opportunity.duration} </p>
                        <div class="product-buttons">
                            <button class="product-button-add" type="button">Apply Now</button>
                            <button class="product-button-like" type="button"><span>♥</span></button>
                        </div>
                    `;
                    popupContainer.innerHTML = ''; // Clear any existing content
                    popupContainer.appendChild(popup);
                    popupContainer.style.display = 'flex'; // Show the popup container

                    const popupHeight = popup.offsetHeight + 100; // Add 100px to the natural height
                    popup.style.height = `${popupHeight}px`;
                });
            });

            window.addEventListener('click', function() {
                popupContainer.style.display = 'none'; // Hide the popup container
                popupContainer.innerHTML = ''; // Clear the popup content
            });

            popupContainer.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent the click from propagating to the window
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Push the initial state to the history stack if it's empty
            if (!history.state) {
                const initialUrl = `${window.location.origin}${window.location.pathname}`;
                history.replaceState({ path: initialUrl }, '', initialUrl);
            }

            attachEventListeners();

            const searchParams = new URLSearchParams(window.location.search);
            const searchValue = searchParams.get('s');
            if (searchValue) {
                document.getElementById('searchInput').value = searchValue;
                searchOpportunities();
            } else {
                loadOpportunities(window.opportunityData, currentPage);
                setupPagination(window.opportunityData);
            }
        });

        window.addEventListener('popstate', function(event) {
            const searchParams = new URLSearchParams(window.location.search);
            const searchValue = searchParams.get('s');
            if (searchValue) {
                document.getElementById('searchInput').value = searchValue;
                searchOpportunities(false);
            } else {
                document.getElementById('searchInput').value = '';
                loadOpportunities(window.opportunityData, currentPage);
                setupPagination(window.opportunityData);
            }
        });
    </script>
</body>
</html>